<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <title>å‘¼å‡ºç•ªå·ç®¡ç†</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f0f8ff;
      padding: 1.5rem;
      max-width: 1600px;
      margin: auto;
      display: flex;
      gap: 2rem;
    }

    .left-panel {
      flex: 1;
    }

    .right-panel {
      width: 320px;
    }

    .call-header {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }

    .call-box {
      background-color: white;
      border-radius: 15px;
      padding: 5px;
      width: 30%;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .call-box .label {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .call-box .waiting-list {
      justify-content: center;
      min-height: 60px;
    }

    .waiting-area {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      padding: 10px;
    }

    .waiting-area h2 {
      font-size: 1.2em;
      margin-bottom: 10px;
    }

    .waiting-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      min-height: 60px;
    }

    .waiting-number {
      background-color: #e0f0ff;
      border: 2px solid #007acc;
      color: #007acc;
      font-weight: bold;
      font-size: 2em;
      padding: 12px 0;
      border-radius: 10px;
      cursor: move;
      user-select: none;
      width: 80px;
      text-align: center;
      position: relative;
      flex-shrink: 0;
    }

    .waiting-number.red {
      background-color: #ffe5e5;
      border-color: #cc6666;
      color: #cc0000;
    }

    .context-menu {
      position: absolute;
      background-color: #fff;
      border: 1px solid #ccc;
      z-index: 1000;
      padding: 5px 10px;
      font-size: 0.9em;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      cursor: pointer;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      margin-bottom: 12px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    button:active {
      transform: scale(0.97);
      background-color: #0056b3;
    }

    .settings-box {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      margin-top: 20px;
    }

    .form-group {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group label {
      font-size: 1em;
      white-space: nowrap;
    }

    select {
      padding: 8px 12px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
    }

    .checkbox-group input[type="checkbox"] {
      transform: scale(1.4);
      margin-left: 5px;
    }

    .inactive-section {
      opacity: 0.4;
    }
  </style>
</head>
<body>
  <div class="left-panel">
    <div class="call-header">
      <div class="call-box waiting-area">
        <div class="label">ğŸ©ºè¨ºå¯Ÿâ‘ </div>
        <div class="waiting-list" id="doctor1-called"></div>
      </div>
      <div class="call-box waiting-area">
        <div class="label">ğŸ©ºè¨ºå¯Ÿâ‘¡</div>
        <div class="waiting-list" id="doctor2-called"></div>
      </div>
      <div class="call-box waiting-area">
        <div class="label">ğŸ¦´ãƒªãƒãƒ“ãƒª</div>
        <div class="waiting-list" id="rehab-called"></div>
      </div>
    </div>

    <div class="waiting-area">
      <h2>ğŸ©ºè¨ºå¯Ÿâ‘  ãŠå¾…ã¡ã®æ–¹</h2>
      <div class="waiting-list" id="doctor1-waiting"></div>
    </div>

    <div class="waiting-area">
      <h2>ğŸ©ºè¨ºå¯Ÿâ‘¡ ãŠå¾…ã¡ã®æ–¹</h2>
      <div class="waiting-list" id="doctor2-waiting"></div>
    </div>

    <div class="waiting-area">
      <h2>ğŸ¦´ãƒªãƒãƒ“ãƒª ãŠå¾…ã¡ã®æ–¹</h2>
      <div class="waiting-list" id="rehab-waiting"></div>
    </div>

    <div class="waiting-area">
      <h2>å®Œäº†ç•ªå·ï¼ˆä¿æŒã‚¨ãƒªã‚¢ï¼‰</h2>
      <div class="waiting-list" id="completed-list"></div>
    </div>
  </div>

  <div class="right-panel">
    <input type="text" id="number-input" placeholder="ç•ªå·ã‚’å…¥åŠ›" inputmode="numeric" pattern="[0-9]*" maxlength="3">
    <button onclick="addNumber('doctor1-waiting')">è¨ºå¯Ÿâ‘ ã«è¿½åŠ </button>
    <button onclick="addNumber('doctor2-waiting')">è¨ºå¯Ÿâ‘¡ã«è¿½åŠ </button>
    <button onclick="addNumber('rehab-waiting')">ãƒªãƒãƒ“ãƒªã«è¿½åŠ </button>
    
    <button onclick="saveToAPI()">ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜</button>

    <div class="settings-box">
      <div class="form-group">
        <label for="display-mode">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼š</label>
        <select id="display-mode" onchange="updateDisplayFlag()">
          <option value="true">è¨ºå¯Ÿâ‘ ï¼‹â‘¡</option>
          <option value="false">è¨ºå¯Ÿâ‘ ã®ã¿</option>
        </select>
      </div>
    
      <div class="form-group checkbox-group">
        <label for="emergency-switch">ç·Šæ€¥å‡¦ç½®å¯¾å¿œä¸­ï¼š</label>
        <input type="checkbox" id="emergency-switch" onchange="toggleEmergency()" />
      </div>
    </div>

    <div class="settings-box">
      <textarea id="notice-input" placeholder="ãŠçŸ¥ã‚‰ã›ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" rows="4" style="width: 100%; font-size: 1em; margin-bottom: 10px;"></textarea>
      <button onclick="saveNotice()">ãŠçŸ¥ã‚‰ã›ã‚’æ›´æ–°</button>
    </div>
  </div>
  
  

  <script>
    const lists = {};
    const allIds = [
      'doctor1-waiting', 'doctor2-waiting', 'rehab-waiting',
      'doctor1-called', 'doctor2-called', 'rehab-called',
      'completed-list'
    ];

    allIds.forEach(id => lists[id] = document.getElementById(id));

    const initialData = {
      // 'doctor1-waiting': ['013', '015', '016'],
      // 'doctor2-waiting': ['020', '022'],
      // 'rehab-waiting': ['006', '008'],
      // 'doctor1-called': ['014'],
      // 'doctor2-called': ['021'],
      // 'rehab-called': ['007'],
      // 'completed-list': []
      'doctor1-waiting': [],
      'doctor2-waiting': [],
      'rehab-waiting': [],
      'doctor1-called': [],
      'doctor2-called': [],
      'rehab-called': [],
      'completed-list': []
    };

    function renderList(container, list, id) {
      container.innerHTML = '';
      list.forEach(num => {
        const card = createCard(num.replace(/^!/, ''), container); // â† !ã‚’é™¤ã„ãŸè¡¨ç¤º
        if (!card) return;

        if (num.startsWith('!')) {
          card.classList.add('red'); // â† èµ¤ãã™ã‚‹
        }
        container.appendChild(card);
      });
    }

    allIds.forEach(id => {
      Sortable.create(lists[id], {
        group: {
          name: 'shared',
          pull: true,
          put: true,
          clone: false
        },
        animation: 150,
        sort: true,
        ghostClass: 'sortable-ghost',   // â† optional: ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦‹ãŸç›®å¤‰åŒ–
        dragClass: 'sortable-drag',     // â† optional: ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦‹ãŸç›®å¤‰åŒ–
        onEnd: () => saveToAPI(),
        onAdd: function (evt) {
          if (!evt.item || !evt.to) return;

          const addedItem = evt.item;
          const parent = evt.to;

          const existing = Array.from(parent.children).filter(el => el !== addedItem && el.textContent === addedItem.textContent);
          if (existing.length > 0) {
            addedItem.remove();
          }
          saveToAPI();
        }
      });
    });

    function createCard(num, container) {
      const cleanNum = num.replace(/^!/, ''); // !ã‚’é™¤å»ã—ã¦æ¯”è¼ƒç”¨ã®ç•ªå·ã‚’ä½œæˆ

      // --- é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆcontainerå†…ã«åŒã˜ç•ªå·ãŒã‚ã‚‹ã‹ï¼‰
      const exists = Array.from(container.children).some(card => card.textContent === cleanNum);
      if (exists) {
        console.warn(`ç•ªå· ${cleanNum} ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™`);
        return null;
      }

      // --- ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
      const el = document.createElement('div');
      el.className = 'waiting-number';
      el.textContent = cleanNum;

      el.addEventListener('dblclick', () => {
        el.classList.toggle('red');
        saveToAPI();
      });

      el.addEventListener('contextmenu', e => {
        e.preventDefault();
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.textContent = 'å‰Šé™¤';
        document.body.appendChild(menu);
        menu.style.top = `${e.pageY}px`;
        menu.style.left = `${e.pageX}px`;

        const removeMenu = () => {
          if (document.body.contains(menu)) document.body.removeChild(menu);
          document.removeEventListener('click', removeMenu);
        };

        menu.addEventListener('click', () => {
          el.remove();
          removeMenu();
          saveToAPI();
        });

        setTimeout(() => document.addEventListener('click', removeMenu), 0);
      });

      return el;
    }

    allIds.forEach(id => {
      const container = lists[id];
      renderList(container, initialData[id], id);
    });

    function getDragAfterElement(container, x) {
      const draggableElements = [...container.querySelectorAll('.waiting-number:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - box.left - box.width / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    const numberInput = document.getElementById('number-input');
    numberInput.addEventListener('input', () => {
      numberInput.value = numberInput.value.replace(/[^0-9]/g, '');
    });

    function addNumber(targetId) {
      const num = numberInput.value.trim();
      if (num && lists[targetId]) {
        const allCards = document.querySelectorAll('.waiting-number');
        const exists = Array.from(allCards).some(c => c.textContent === num);
        if (exists) {
          alert("åŒã˜ç•ªå·ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚");
          return;
        }
        const el = createCard(num);
        lists[targetId].appendChild(el);
        numberInput.value = '';
        saveToAPI();
      }
    }
    
    function saveToAPI() {
      const data = {};
      allIds.forEach(id => {
        data[id] = Array.from(lists[id].children).map(el => {
          return el.classList.contains('red') ? `!${el.textContent}` : el.textContent;
        });
      });

      fetch('/api/waiting', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(res => res.json())
        .then(data => {
          console.log('ä¿å­˜æˆåŠŸ', data);
          // alert("ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
        }).catch(err => {
          console.error('ä¿å­˜å¤±æ•—', err);
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
        });
    }

    function toggleEmergency() {
      const isEmergency = document.getElementById('emergency-switch').checked;
      fetch('/api/emergency', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ emergency: isEmergency })
      });
      saveToAPI();
    }

    function updateDisplayFlag() {
      const mode = document.getElementById('display-mode').value === 'true';
      fetch('/api/display-flag', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ doctor2: mode })
      }).then(res => res.json())
        .then(data => {
          console.log('è¡¨ç¤ºãƒ•ãƒ©ã‚°æ›´æ–°:', data);
        });
    }

    function saveNotice() {
      const text = document.getElementById('notice-input').value;
      fetch('/api/notice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notice: text })
      })
      .then(res => res.json())
      .then(data => {
        console.log("ãŠçŸ¥ã‚‰ã›æ›´æ–°æˆåŠŸ:", data);
      })
      .catch(err => {
        console.error("ãŠçŸ¥ã‚‰ã›æ›´æ–°å¤±æ•—:", err);
        alert("ãŠçŸ¥ã‚‰ã›ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
      });
    }

    function updateDisplayFlag() {
      const mode = document.getElementById('display-mode').value === 'true'; // true = â‘ ï¼‹â‘¡

      fetch('/api/display-flag', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ doctor2: mode })
      }).then(res => res.json())
        .then(data => {
          console.log('è¡¨ç¤ºãƒ•ãƒ©ã‚°æ›´æ–°:', data);
          
          // ğŸ‘‡ è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸUIåˆ¶å¾¡å‡¦ç†
          handleDoctor2Mode(mode);
        });

      // ğŸ”½ è¨ºå¯Ÿâ‘¡ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹ãƒ»ç„¡åŠ¹åˆ‡æ›¿å‡¦ç†è¿½åŠ ï¼
      const doctor2Button = document.querySelector('button[onclick*="doctor2-waiting"]');
      if (mode) {
        doctor2Button.disabled = false;
        doctor2Button.style.opacity = "1";
      } else {
        doctor2Button.disabled = true;
        doctor2Button.style.opacity = "0.5";
      }
    }

    function handleDoctor2Mode(showDoctor2) {
      const doctor2Waiting = document.getElementById('doctor2-waiting');
      const doctor2Called = document.getElementById('doctor2-called');

      const doctor2WaitingArea = doctor2Waiting.closest('.waiting-area');
      const doctor2CalledBox = doctor2Called.closest('.call-box');

      if (!showDoctor2) {
        // è¨ºå¯Ÿâ‘¡ã®ç•ªå·ã‚’å®Œäº†ãƒªã‚¹ãƒˆã¸ç§»å‹•
        [...doctor2Waiting.children, ...doctor2Called.children].forEach(card => {
          lists['completed-list'].appendChild(card);
        });

        // å®Œå…¨ã«éè¡¨ç¤º
        doctor2WaitingArea.style.display = 'none';
        doctor2CalledBox.style.display = 'none';

      } else {
        // è¡¨ç¤ºã‚’å…ƒã«æˆ»ã™
        doctor2WaitingArea.style.display = '';
        doctor2CalledBox.style.display = '';
      }

      saveToAPI();
    }



    async function fetchLatestWaitingData() {
      try {
        const res = await fetch('/api/waiting');
        const latest = await res.json();

        allIds.forEach(id => {
          const container = lists[id];
          renderList(container, latest[id] || [], id);
        });
      } catch (err) {
        console.error("æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—", err);
      }
    }

    // â˜… è¿½åŠ ï¼å®šæœŸçš„ã«æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ã—ã¦UIã«åæ˜ 
    setInterval(fetchLatestWaitingData, 3000); // 3ç§’ãŠãã«å–å¾—ï¼ˆé »åº¦ã¯èª¿æ•´å¯ï¼‰

  </script>
</body>
</html>

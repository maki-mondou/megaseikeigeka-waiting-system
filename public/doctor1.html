<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¨ºå¯Ÿâ‘  å…ˆç”Ÿç”»é¢</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f0f0f0;
      padding: 2rem;
      text-align: center;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .current-call {
      font-size: 6rem;
      font-weight: bold;
      color: #007bff;
      margin: 2rem 0;
      cursor: pointer;
    }

    .waiting-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }

    .waiting-number {
      background-color: #e0f0ff;
      border: 2px solid #007acc;
      border-radius: 10px;
      padding: 1rem 2rem;
      font-size: 2rem;
      font-weight: bold;
      color: #007acc;
      user-select: none;
    }
  </style>
</head>
<body>
  <h1>è¨ºå¯Ÿâ‘  å‘¼å‡ºä¸­</h1>

  <div id="current-call" class="current-call">--</div>

  <h2>å¾…æ©Ÿä¸­ã®ç•ªå·</h2>
  <div id="waiting-list" class="waiting-list"></div>

  <script>
  async function fetchData() {
    const res = await fetch('/api/waiting');
    const data = await res.json();

    const currentRaw = data['doctor1-called'][0] || '--';
    const currentCall = document.getElementById('current-call');

    const isRed = currentRaw.startsWith('!');
    const current = currentRaw.replace(/^!/, '');

    currentCall.textContent = current;
    currentCall.style.color = isRed ? 'red' : '#007bff'; // â† è‰²åˆ‡ã‚Šæ›¿ãˆï¼

    currentCall.dataset.original = currentRaw;

    const waiting = data['doctor1-waiting'] || [];
    const waitingList = document.getElementById('waiting-list');
    waitingList.innerHTML = '';

    waiting.forEach(num => {
      const span = document.createElement('div');
      span.className = 'waiting-number';
      span.textContent = num.replace(/^!/, '');

      if (num.startsWith('!')) {
        span.style.color = 'red';
      }

      waitingList.appendChild(span);
    });
  }

    async function completeCurrentCall() {
      const currentCall = document.getElementById('current-call');
      const num = currentCall.dataset.original;
      if (num === '--') return;

      console.log("å®Œäº†å‡¦ç†ï¼šã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸç•ªå·", num); // â† è¿½åŠ 

      // ğŸ”’ é€£æ‰“é˜²æ­¢ï¼ˆ1ç§’é–“ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹ã«ï¼‰
      currentCall.style.pointerEvents = 'none';
      setTimeout(() => {
        currentCall.style.pointerEvents = '';
      }, 1000);

      // ç”»é¢ã‹ã‚‰å³æ™‚å‰Šé™¤ï¼ˆéè¡¨ç¤ºã«ã™ã‚‹ï¼‰
      currentCall.textContent = '--';

      // å®Œäº†å‡¦ç†ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€šçŸ¥
      const res = await fetch('/api/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ doctor: 'doctor1', number: num })
      });

      // å¿µã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå‘¼å‡ºä¸­ã‚„å¾…æ©Ÿä¸­ãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ï¼‰
      if (res.ok) {
        await fetchData();
      } else {
        alert("å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
        currentCall.textContent = num; // æˆ»ã™
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    document.getElementById('current-call').addEventListener('click', completeCurrentCall);

    // åˆå›èª­ã¿è¾¼ã¿ & å®šæœŸæ›´æ–°
    fetchData();
    setInterval(fetchData, 5000); // 5ç§’ã”ã¨ã«æ›´æ–°
  </script>
</body>
</html>

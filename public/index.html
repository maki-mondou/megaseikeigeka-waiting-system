<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>呼出モニター</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f0f8ff;
      padding: 1.5rem;
      max-width: 1200px;
      margin: auto;
    }
    .call-header {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 20px;
    }
    .call-box {
      background-color: white;
      border-radius: 15px;
      padding: 15px;
      width: 28%;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      text-align: center;
    }
    .call-box.doctor1 { border-top: 10px solid #007bff; }
    .call-box.doctor2 { border-top: 10px solid #0056b3; }
    .call-box.rehab   { border-top: 10px solid #28a745; }

    .label {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .number {
      font-size: 3.5em;
      font-weight: bold;
      color: #333;
    }

    .waiting-area {
      background-color: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      position: relative;
      padding-left: 20px;
    }

    .waiting-area.doctor1::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 8px;
      height: 100%;
      background-color: #007bff;
      border-radius: 12px 0 0 12px;
    }
    .waiting-area.doctor2::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 8px;
      height: 100%;
      background-color: #0056b3;
      border-radius: 12px 0 0 12px;
    }
    .waiting-area.rehab::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 8px;
      height: 100%;
      background-color: #28a745;
      border-radius: 12px 0 0 12px;
    }

    .waiting-area h2 {
      font-size: 1.6em;
      margin-bottom: 15px;
    }

    .waiting-number {
      display: inline-block;
      background-color: #e0f0ff;
      border: 2px solid #007acc;
      color: #007acc;
      font-size: 1.8em;
      font-weight: bold;
      padding: 12px 20px;
      margin: 5px;
      border-radius: 15px;
      width: 60px;
      text-align: center;
    }

    .waiting-number.initial {
      background-color: #ffe5e5;
      border-color: #cc6666;
      color: #cc0000;
    }

    .ticker {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #004080;
      color: #fff;
      font-size: 1.2em;
      font-weight: bold;
      overflow: hidden;
      height: 2.5rem;
      display: flex;
      align-items: center;
    }

    .ticker-text {
      white-space: nowrap;
      display: inline-block;
      padding-right: 100%;
      animation: scroll-left 40s linear infinite;
    }

    .waiting-number.red {
      background-color: #ffe5e5;
      border-color: #cc6666;
      color: #cc0000;
    }

    #emergency-banner {
      position: fixed;
      top: 35%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #cc0000; /* 濃い赤 */
      color: #ffff00; /* 黄色文字 */
      font-size: 4em;
      font-weight: bold;
      padding: 1em 2em;
      border: 8px solid #ffff00;
      border-radius: 30px;
      z-index: 9999;
      box-shadow: 0 0 30px rgba(255, 0, 0, 0.7);
      text-align: center;
      white-space: nowrap;
    }

    .number.initial {
      color: #cc0000 !important;
    }

    @keyframes blink {
      50% { opacity: 0.4; }
    }

    @keyframes scroll-left {
      0% {
        transform: translateX(100%);
      }
      100% {
        transform: translateX(-100%);
      }
    }
  </style>
</head>
<body>
  <div class="call-header">
    <div class="call-box doctor1">
      <div class="label">🩺診察①</div>
      <div class="number" id="doctor1-called">--</div>
    </div>
    <div class="call-box doctor2" id="doctor2-section">
      <div class="label">🩺診察②</div>
      <div class="number" id="doctor2-called">--</div>
    </div>
    <div class="call-box rehab">
      <div class="label">🦴リハビリ</div>
      <div class="number" id="rehab-called">--</div>
    </div>
  </div>

  <div class="waiting-area doctor1">
    <h2>🩺診察① お待ちの方</h2>
    <div id="doctor1-waiting"></div>
  </div>

  <div class="waiting-area doctor2" id="doctor2-waiting-section">
    <h2>🩺診察② お待ちの方</h2>
    <div id="doctor2-waiting"></div>
  </div>

  <div class="waiting-area rehab">
    <h2>🦴リハビリ お待ちの方</h2>
    <div id="rehab-waiting"></div>
  </div>

  <div class="ticker">
    <div class="ticker-text" id="ticker-text">
      <!-- ここにお知らせが入る -->
    </div>
  </div>

  <div id="emergency-banner" style="display: none;">
    🚨 緊急処置対応中 🚨
  </div>

  <script>

    async function updateDisplaySetting() {
      const res = await fetch('/api/display-flag');
      const data = await res.json();
      const showDoctor2 = data.doctor2;

      const doctor2Elements = [
        document.getElementById('doctor2-called'),
        document.getElementById('doctor2-waiting')
      ];

      doctor2Elements.forEach(el => {
        if (el) el.parentElement.style.display = showDoctor2 ? '' : 'none';
      });
    }

    function renderCards(containerId, list) {
      const container = document.getElementById(containerId);
      if (!container) return;  // ← 要素が存在しないなら描画しない
        container.innerHTML = '';
        list.forEach(num => {
        const span = document.createElement('span');
        span.className = 'waiting-number';
        if (num.startsWith('!')) {
          span.classList.add('initial');
          num = num.slice(1);
        }
        span.textContent = num;
        container.appendChild(span);
      });
    }

    async function fetchWaitingData() {
      try {
        const res = await fetch('/api/waiting');
        const data = await res.json();

        renderCards('doctor1-waiting', data['doctor1-waiting'] || []);
        renderCards('doctor2-waiting', data['doctor2-waiting'] || []);
        renderCards('rehab-waiting', data['rehab-waiting'] || []);

        const doc1 = document.getElementById('doctor1-called');
        const doc2 = document.getElementById('doctor2-called');
        const rehab = document.getElementById('rehab-called');

        // if (doc1) doc1.textContent = data['doctor1-called']?.[0] || '--';
        // if (doc2) doc2.textContent = data['doctor2-called']?.[0] || '--';
        // if (rehab) rehab.textContent = data['rehab-called']?.[0] || '--';
        if (doc1) {
          const num = data['doctor1-called']?.[0] || '--';
          doc1.textContent = num.replace(/^!/, '');
          if (num.startsWith('!')) {
            doc1.classList.add('initial'); // ← 赤文字スタイル
          } else {
            doc1.classList.remove('initial'); // ← 通常スタイルに戻す
          }
        }

        if (doc2) {
          const num = data['doctor2-called']?.[0] || '--';
          doc2.textContent = num.replace(/^!/, '');
          if (num.startsWith('!')) {
            doc2.classList.add('initial');
          } else {
            doc2.classList.remove('initial');
          }
        }

        if (rehab) {
          const num = data['rehab-called']?.[0] || '--';
          rehab.textContent = num.replace(/^!/, '');
          if (num.startsWith('!')) {
            rehab.classList.add('initial');
          } else {
            rehab.classList.remove('initial');
          }
        }


      } catch (err) {
        console.error('❌ データ取得失敗:', err);
      }
    }

    async function fetchEmergencyStatus() {
      try {
        const res = await fetch('/api/emergency');
        const data = await res.json();
        const banner = document.getElementById('emergency-banner');
        banner.style.display = data.emergency ? 'block' : 'none';
      } catch (err) {
        console.error('緊急処置ステータス取得失敗:', err);
      }
    }

    function fetchNotice() {
      fetch('/api/notice')
        .then(res => res.json())
        .then(data => {
          document.getElementById('ticker-text').textContent = data.notice || '';
        });
    }

    // 最初に取得
    fetchNotice();
    // 30秒ごとに更新
    setInterval(fetchNotice, 30000);

    fetchEmergencyStatus();
    setInterval(fetchEmergencyStatus, 5000);
    fetchWaitingData();
    setInterval(fetchWaitingData, 5000);
    updateDisplaySetting();
  </script>
</body>
</html>
